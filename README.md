# W9 Tools

W9 Tools is a lightweight utility stack for instant link shortening, markdown notepads, and secure file sharing. Built with Rust (Axum) backend and React/Vite frontend, it provides a minimal, single-binary deployment with SQLite and local filesystem storage.

## Table of Contents

- [Overview](#overview)
- [Sponsorship](#sponsorship)
- [For Website Users](#for-website-users)
  - [Getting Started](#getting-started)
  - [Short Links](#short-links)
  - [Markdown Notepads](#markdown-notepads)
  - [File Sharing](#file-sharing)
  - [QR Codes](#qr-codes)
  - [User Account](#user-account)
- [For Developers / Deployment](#for-developers--deployment)
  - [Prerequisites](#prerequisites)
  - [Quick Installation](#quick-installation)
  - [Configuration](#configuration)
  - [Environment Variables](#environment-variables)
  - [Service Management](#service-management)
  - [Email Integration](#email-integration)
  - [Troubleshooting](#troubleshooting)
- [Architecture](#architecture)
- [Local Development](#local-development)
- [Contributing](#contributing)
- [License](#license)

## Overview

W9 Tools provides:
- **Short Links**: Create short URLs pointing to any destination
- **Markdown Notepads**: Write and share markdown notes with custom short codes
- **File Sharing**: Upload and share files with automatic previews for images/media
- **QR Codes**: Generate QR codes for all short links
- **User Authentication**: Register, verify email, login, password reset
- **Admin Panel**: Manage items, users, and email sender configuration

**Tech Stack:**
- **Backend**: Rust (Axum + Askama templates)
- **Frontend**: React + Vite + TypeScript
- **Database**: SQLite (single file)
- **Storage**: Local filesystem (`uploads/`)
- **Deployment**: Systemd service + Nginx reverse proxy

---

## Sponsorship

W9 Tools is community-funded. Two core partners currently cover operational costs:

| Sponsor | Contribution |
|---------|-------------|
| **1Password** | Secure credential vault and secrets management for the release team. |
| **Sentry** | “Sentry automatically detects and notifies you of critical performance issues so you can trace every slow transaction to a poor-performing API call or DB query.” |

Want to help? Email [hi@w9.se](mailto:hi@w9.se) to get involved or be listed here.

---

## For Website Users

### Getting Started

1. **Register**: Click "Sign up" and create an account with your email
2. **Verify Email**: Check your email for a verification link (expires in 30 minutes)
3. **Login**: After verification, log in with your credentials
4. **Change Password**: If required, update your password on first login

### Short Links

Create short, memorable links for any URL.

#### Creating a Short Link

1. Go to **Short** page (`/short`)
2. Enter the destination URL
3. Optionally:
   - Enter a custom code (3-32 characters, alphanumeric, dashes, underscores)
   - Check "Generate QR Code" to create a QR code
4. Click **Create Short Link**
5. Copy and share your short link (e.g., `https://w9.se/s/abc123`)

#### Viewing Short Links

- Click on your short link to be redirected to the destination
- If QR code was generated, it will be displayed on the short link page
- QR codes include the W9 logo in the center (if configured)

### Markdown Notepads

Create and share markdown notes with custom short codes.

#### Creating a Notepad

1. Go to **Note** page (`/note`)
2. Enter your markdown content
3. Optionally:
   - Enter a custom code (3-32 characters)
   - Check "Generate QR Code" to create a QR code
4. Click **Create Notepad**
5. Share your notepad link (e.g., `https://w9.se/n/my-note`)

#### Viewing Notepads

- Visit `/n/<code>` to view the rendered markdown
- Markdown is server-side rendered with syntax highlighting
- Notepads include a "Generated by W9 Tools" footer with link to `w9.se`

### File Sharing

Upload and share files with automatic previews.

#### Supported File Types

- **Images**: JPEG, PNG, GIF, WebP, SVG
- **PDFs**: Embedded PDF viewer
- **Videos**: MP4, WebM, MOV, AVI, MKV (HTML5 player)
- **Other files**: Generic download page

#### Uploading Files

1. Go to **Short** page (`/short`)
2. Click **Choose File** and select your file
3. Optionally:
   - Enter a custom code
   - Check "Generate QR Code"
4. Click **Upload**
5. Share your file link (e.g., `https://w9.se/s/file123`)

#### File Previews

- **Images**: Full-size preview with download option
- **Large Images**: Automatic thumbnail generation for files >1MB
- **PDFs**: Embedded viewer with download option
- **Videos**: HTML5 video player with controls
- **Other files**: Download page with file info

### QR Codes

QR codes are generated for all short links when requested.

#### Features

- Monochrome black/white design matching frontend
- Optional logo embedding in center (configurable)
- 2px white border for better scanning
- Data URL format for easy embedding

#### Generating QR Codes

- Check "Generate QR Code" when creating a short link, notepad, or uploading a file
- QR codes are displayed on the short link page
- QR codes can also be generated via API with `?qr=1` parameter

### User Account

#### Profile Management

1. Go to **Profile** (`/profile`)
2. View your account details:
   - Email address
   - Role (user/admin)
   - Password change requirement status
3. Change your password if needed

#### Your Items

1. Go to **Profile** → **Your Items**
2. View all your created items:
   - Short links
   - Notepads
   - Uploaded files
3. Each item shows:
   - Short code
   - Type (url/file/notepad)
   - Creation date
   - Short URL

#### Managing Items

- **Update Custom Code**: Change the short code for any item
- **Delete Items**: Remove items you no longer need
- Items are automatically deleted when you delete your account

---

## For Developers / Deployment

### Prerequisites

- Ubuntu/Debian server with sudo access
- Git
- Rust toolchain (installed automatically)
- Node.js 18+ and npm (installed automatically)
- Domain pointing to the server (optional but recommended)

### Quick Installation

1. **Clone the repository:**
   ```bash
   git clone https://github.com/ShayNeeo/w9-tools.git
   cd w9-tools
   ```

2. **Run the installer with environment variables:**
   ```bash
   DOMAIN=w9.se \
   BASE_URL=https://w9.se \
   W9_MAIL_API_URL=https://w9.nu \
   W9_MAIL_API_TOKEN=your-jwt-token-from-w9-mail \
   sudo -E ./deploy/install.sh
   ```

The installer performs:
- Installs required packages (Rust, Node.js, nginx, sqlite, etc.)
- Builds the backend (`cargo build --release`)
- Builds the frontend (`npm ci && npm run build`)
- Deploys binary to `/opt/w9`
- Deploys frontend to `/var/www/w9`
- Creates systemd service (`w9.service`)
- Configures nginx reverse proxy with TLS
- Sets up environment variables in `/etc/default/w9`
- Opens ports 80/443 via ufw

3. **Verify installation:**
   ```bash
   systemctl status w9
   journalctl -u w9 -f
   ```

4. **Access the web interface:**
   Visit `https://your-domain` in your browser

### Configuration

Configuration is stored in `/etc/default/w9` (created by the installer).

#### Environment Variables

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `HOST` | Backend bind address | `0.0.0.0` | No |
| `PORT` | Backend port | `8080` | No |
| `BASE_URL` | Public base URL for short links | `http://localhost:8080` | **Yes** |
| `DATABASE_PATH` | SQLite database path | `data/w9.db` | No |
| `UPLOADS_DIR` | Filesystem directory for uploads | `uploads` | No |
| `PASSWORD_RESET_BASE_URL` | Password reset link base | `${BASE_URL}/reset-password` | No |
| `VERIFICATION_BASE_URL` | Email verification link base | `${BASE_URL}/verify-email` | No |
| `W9_MAIL_API_URL` | w9-mail base URL | `https://w9.nu` | **Yes** (for emails) |
| `W9_MAIL_API_TOKEN` | JWT token from w9-mail | - | **Yes** (for emails) |
| `EMAIL_FROM_ADDRESS` | Fallback sender address | `W9 Tools <no-reply@domain>` | No |
| `QR_LOGO_PATH` | Path to logo for QR codes | `/var/www/w9/android-chrome-512x512.png` | No |
| `JWT_SECRET` | Secret for JWT tokens | `change-me-in-production` | **Yes** (change!) |
| `TURNSTILE_SECRET_KEY` | Cloudflare Turnstile secret | - | No |

> **Security Note**: Always change `JWT_SECRET` to a strong random string in production!

#### Updating Configuration

1. Edit `/etc/default/w9`:
   ```bash
   sudo nano /etc/default/w9
   ```

2. Restart the service:
   ```bash
   sudo systemctl restart w9
   ```

### Service Management

#### Check Service Status
```bash
systemctl status w9
```

#### View Logs
```bash
# Follow logs in real-time
journalctl -u w9 -f

# View recent logs
journalctl -u w9 -n 100
```

#### Restart Service
```bash
sudo systemctl restart w9
```

#### Redeploy After Code Changes
```bash
cd /path/to/w9-tools
git pull
sudo -E ./deploy/install.sh
```

> **Note**: The installer detects changes and only rebuilds what's necessary. To force a frontend rebuild, remove `frontend/dist` before running the installer.

### Email Integration

W9 Tools sends transactional emails (verification, password reset) through w9-mail.

#### Setup

1. **Get JWT Token from w9-mail:**
   ```bash
   curl -X POST https://w9.nu/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@example.com","password":"password"}'
   ```
   Copy the `token` from the response.

2. **Configure in w9-tools:**
   ```bash
   sudo nano /etc/default/w9
   # Add:
   W9_MAIL_API_URL=https://w9.nu
   W9_MAIL_API_TOKEN=your-jwt-token-here
   sudo systemctl restart w9
   ```

3. **Configure Email Sender (Admin Panel):**
   - Login as admin
   - Go to **Admin** → **Email Sender** tab
   - Select a w9-mail account or alias to use for transactional emails
   - This choice is stored locally and used for all future emails

#### Email Features

- **Registration Verification**: Sent when users sign up (expires in 30 minutes)
- **Password Reset**: Sent when users request password reset (expires in 30 minutes)
- **Email Template**: Monochrome design matching w9-tools branding
- **W9 Logo**: Centered logo in email header

### Troubleshooting

#### Service Won't Start
- **Problem**: `systemctl status w9` shows failed
- **Solution**:
  - Check logs: `journalctl -u w9 -n 50`
  - Verify environment variables in `/etc/default/w9`
  - Check port is not in use: `sudo lsof -i :8080`
  - Verify database/uploads directories exist and are writable

#### Email Sending Fails
- **Problem**: Verification/reset emails not sent
- **Solution**:
  - Verify `W9_MAIL_API_URL` and `W9_MAIL_API_TOKEN` are correct
  - Check w9-mail service is running and accessible
  - Verify JWT token hasn't expired (get a new one from w9-mail)
  - Check admin panel has email sender configured

#### File Upload Issues
- **Problem**: Files fail to upload or previews don't generate
- **Solution**:
  - Check `UPLOADS_DIR` exists and is writable
  - Verify disk space: `df -h`
  - Check file permissions: `ls -la uploads/`
  - Ensure ImageMagick is installed for image previews

#### Database Issues
- **Problem**: Database errors or permission denied
- **Solution**:
  - Verify `DATABASE_PATH` exists and is writable
  - Check service user permissions
  - Ensure SQLite is installed: `sudo apt install sqlite3`
  - Check database file: `sqlite3 data/w9.db ".tables"`

#### QR Code Logo Not Showing
- **Problem**: QR codes don't have logo in center
- **Solution**:
  - Verify `QR_LOGO_PATH` points to existing file
  - Check file is readable: `ls -la /var/www/w9/android-chrome-512x512.png`
  - Logo should be PNG, JPEG, or SVG format
  - Default path: `/var/www/w9/android-chrome-512x512.png`

#### nginx SSL Warnings
- **Problem**: SSL certificate warnings
- **Solution**:
  - If using Cloudflare: Use Cloudflare origin certificates
  - Otherwise: Install Let's Encrypt certificates
  - Self-signed certs are generated as fallback by installer

---

## Architecture

### Backend Structure
- `server/src/main.rs` - Application entry point, routes, database setup
- `server/src/handlers.rs` - API endpoint handlers, QR code generation, file handling
- `server/src/templates.rs` - Askama templates for HTML rendering (short links, files, notepads)

### Frontend Structure
- `frontend/src/App.tsx` - Main React application
- `frontend/src/` - React components and pages
- `frontend/public/` - Static assets (favicons, logo, robots.txt)

### Database Schema
- `items` - Short links, files, and notepads
- `users` - User accounts with roles
- `password_reset_tokens` - Password reset tokens (30 min expiration)
- `email_verification_tokens` - Email verification tokens (30 min expiration)
- `settings` - Application settings (email sender config)

### File Storage
- `uploads/` - Original uploaded files
- `uploads/previews/` - Generated previews for large images
- Files are stored with UUID-based names to prevent conflicts

### Security Features
- SHA256 password hashing with salt
- JWT token authentication (24-hour expiration)
- Email verification required for registration
- Password reset with 30-minute token expiration
- Cloudflare Turnstile integration (optional)
- File type validation
- File size limits (configurable)

---

## Local Development

### Backend Development

```bash
# Install Rust (if not already installed)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Run with auto-reload
cargo watch -x "run --bin w9"
```

Backend runs on `http://localhost:8080` by default.

### Frontend Development

```bash
cd frontend
npm install
npm run dev
```

Frontend dev server runs on `http://localhost:5173` by default.

### Environment Variables

Create `frontend/.env` for local development:
```env
VITE_API_BASE_URL=http://localhost:8080
```

### Database

Local development uses `data/w9.db` (created automatically).

---

## Contributing

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/xyz`
3. Make your changes
4. Test thoroughly:
   - Backend: `cargo test`
   - Frontend: `npm run test` (if tests exist)
5. Run linters/formatters:
   - Backend: `cargo fmt && cargo clippy`
   - Frontend: `npm run lint`
6. Commit with descriptive messages
7. Push and open a pull request

---

## License

Licensed under GNU General Public License v3.0. See [LICENSE](LICENSE) file for details.
